/* -*- mode:c -*- */
/**
 * @file action_boilerplate.def
 * @brief Boilerplate provisions for implementing a help display function.
 */

#include "handle.h"            // for TEMPLATEH (handle) prototype
#include "dispatcher.h"        // for AVERB definition
#include "argeater_setters.h"  // argeater_setters sending errors to TEMPLATE_ERROR
#include "error_handling.h"    // for ERROR_SINK function pointer
#include "shell_vars.h"        // for DISPOSE_SHELL_VAR function pointer
#include <stdio.h>             // printf
#include <stdbool.h>           // for bool data type

/***** CONSTRUCT THE ARGUMENT MAP *****/

// STATUS VARIABLES
// File-scope status variable(s) that will contain the
// command-line argument settings after the argument map
// to which they are attached is used by argeater's
// `argeater_process` function.
static bool flag_variable = false;
static SHELL_VAR *retval = NULL;


// ACTIONS ARRAY
// Refer to argeater(3) for documentation, argeater(7) for summary
AE_ITEM boilerplate_actions[] = {
   {(const char**)&flag_variable, "flag", 'f', AET_FLAG_OPTION,
    "set flag to toggle setting", NULL, argeater_bool_setter},

   {(const char **)&retval, "retval", '\0', AET_ARGUMENT,
    "variable name to use for the return value", NULL, TEMPLATE_argeater_return_sv_setter},
};

// ACTION MAP
// Refer to argeater(3) for documentation, argeater(7) for summary
AE_MAP TEMPLATE_boilerplate_arg_map = INIT_MAP(boilerplate_actions);

/***** END CONSTRUCTION OF THE ARGUMENT MAP *****/

/***** Action Implementation *****/

int TEMPLATE_boilerplate(SHELL_VAR *sv_handle, ACLONE *args)
{
   int exit_code = EXECUTION_SUCCESS;

   // Delete these statements if this action does not require a handle:
   __attribute__((unused))
   TEMPLATEH *handle = TEMPLATE_cell(sv_handle);

   // Initialize STATUS VARIABLES for each action invocation:
   flag_variable = false;
   retval = NULL;

   if (!argeater_process(args, &TEMPLATE_boilerplate_arg_map))
   {
      (*ERROR_SINK)("Error process arguments.");
      exit_code = EXECUTION_FAILURE;
   }
   else
   {
      // Perform the action according to the submitted arguments.

      // Example of setting a boolean return value:
      if (retval)
      {
         (*DISPOSE_SHELL_VAR)(retval);
         char *p = xmalloc(2);
         p[0] = '1';
         p[1] = 0;
         retval->value = p;
      }
   }

   return exit_code;
}

/***** AVERB for action table *****/

AVERB TEMPLATE_boilerplate_verb = {
   "boilerplate",                    // verb name to match
   "boilerplate action",             // description to use for 'help' action
   "TEMPLATE boilerplate",           // invocation of verb
   true,                             // true if handle must already be declared
   TEMPLATE_boilerplate,             // reference to action function
   &TEMPLATE_boilerplate_arg_map     // reference to argument map (for help display)
};
